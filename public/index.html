<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Web site created using create-react-app" />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>Udacity Todos Goals</title>

    <!-- Redux Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>

    <!-- React, React-DOM and Babel libraries -->
    <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

    <!-- External API Simulation -->
    <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
  </head>

  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <div id="app"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->

    <script type="text/javascript">
      // Helper Function to generate ID
      function generateId() {
        return Math.random().toString(36).substring(2) + new Date().getTime().toString(36);
      }

      /* App Code */

      const ADD_TODO = 'ADD_TODO';
      const REMOVE_TODO = 'REMOVE_TODO';
      const TOGGLE_TODO = 'TOGGLE_TODO';
      const ADD_GOAL = 'ADD_GOAL';
      const REMOVE_GOAL = 'REMOVE_GOAL';
      const RECEIVE_DATA = 'RECEIVE_DATA';

      // Reducer Function 1
      // Cases to update the internal state of our store
      function todos(state = [], action) {
        // Listen to a specific event type
        switch (action.type) {
          case ADD_TODO:
            return state.concat([action.todo]);
          case REMOVE_TODO:
            return state.filter((todo) => todo.id !== action.id);
          case TOGGLE_TODO:
            return state.map((todo) =>
              todo.id !== action.id ? todo : Object.assign({}, todo, { complete: !todo.complete })
            );
          case RECEIVE_DATA:
            return action.todos;
          default:
            return state;
        }
      }

      // Reducer Function 2
      function goals(state = [], action) {
        switch (action.type) {
          case ADD_GOAL:
            return state.concat([action.goal]);
          case REMOVE_GOAL:
            return state.filter((goal) => goal.id !== action.id);
          case RECEIVE_DATA:
            return action.goals;
          default:
            return state;
        }
      }

      // Reducer Function 3
      function loading(state = true, action) {
        switch (action.type) {
          case RECEIVE_DATA:
            return false;
          default:
            return state;
        }
      }

      // Action Creators
      function addTodoAction(todo) {
        return {
          type: ADD_TODO,
          todo,
        };
      }

      function removeTodoAction(id) {
        return {
          type: REMOVE_TODO,
          id,
        };
      }

      function toggleTodoAction(id) {
        return {
          type: TOGGLE_TODO,
          id,
        };
      }

      function addGoalAction(goal) {
        return {
          type: ADD_GOAL,
          goal,
        };
      }

      function removeGoalAction(id) {
        return {
          type: REMOVE_GOAL,
          id,
        };
      }

      function receiveDataAction(todos, goals) {
        return {
          type: RECEIVE_DATA,
          todos,
          goals,
        };
      }

      function handleDeleteTodo(todo) {
        return (dispatch) => {
          dispatch(removeTodoAction(todo.id));

          return API.deleteTodo(todo.id).catch(() => {
            dispatch(addTodoAction(todo));
            alert('An error occurred. Try again.');
          });
        };
      }

      // Middleware
      const checker = (store) => (next) => (action) => {
        if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')) {
          return alert("Nope. That's a bad idea!");
        }

        if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')) {
          return alert("Nope. That's a bad idea!");
        }

        return next(action);
      };

      const logger = (store) => (next) => (action) => {
        console.group(action.type);
        console.log('The action: ', action);
        const result = next(action);
        console.log('The new state: ', store.getState());
        console.groupEnd();

        return result;
      };

      const thunk = (store) => (next) => (action) => {
        if (typeof action === 'function') {
          return action(store.dispatch);
        }
        return next(action);
      };

      // Create instance of our store, passing a single reducer
      const store = Redux.createStore(
        Redux.combineReducers({
          todos,
          goals,
          loading,
        }),
        Redux.applyMiddleware(thunk, checker, logger)
      );
    </script>

    <script type="text/babel">
      // LIST component
      function List(props) {
        return (
          <ul>
            {props.items.map((item) => (
              <li key={item.id}>
                <span
                  onClick={() => props.toggle && props.toggle(item.id)}
                  style={{ textDecoration: item.complete ? 'line-through' : 'none' }}
                >
                  {item.name}
                </span>
                <button onClick={() => props.remove(item)}>X</button>
              </li>
            ))}
          </ul>
        );
      }

      // TODOS component

      class Todos extends React.Component {
        // Add todo
        addItem = (e) => {
          e.preventDefault();

          const { dispatch } = this.props.store;

          return API.saveTodo(this.input.value)
            .then((todo) => {
              dispatch(addTodoAction(todo));
              this.input.value = '';
            })
            .catch(() => alert('An error occurred. Try again'));
        };

        // Remove todo
        removeItem = (todo) => {
          const { dispatch } = this.props.store;
          dispatch(handleDeleteTodo(todo));
        };

        // Toggle todo
        toggleItem = (id) => {
          const { dispatch } = this.props.store;

          dispatch(toggleTodoAction(id));

          return API.saveTodoToggle(id).catch(() => {
            dispatch(toggleTodoAction(id));
            alert('An error occurred. Try again.');
          });
        };

        render() {
          return (
            <div>
              <h1>Todo List</h1>
              <input type="text" placeholder="Add Todo" ref={(input) => (this.input = input)} />
              <button onClick={this.addItem}>Add Todo</button>

              <List items={this.props.todos} remove={this.removeItem} toggle={this.toggleItem} />
            </div>
          );
        }
      }

      // GOALS component

      class Goals extends React.Component {
        // Add goal
        addItem = (e) => {
          e.preventDefault();

          return API.saveGoal(this.input.value)
            .then((goal) => {
              this.props.store.dispatch(addGoalAction(goal));
              this.input.value = '';
            })
            .catch(() => alert('An error occurred. Try again.'));
        };

        // Remove goal
        removeItem = (goal) => {
          this.props.store.dispatch(removeGoalAction(goal.id));

          return API.deleteGoal(goal.id).catch(() => {
            this.props.store.dispatch(addGoalAction(goal));
            alert('An error occurred. Try again.');
          });
        };

        render() {
          return (
            <div>
              <h1>Goals</h1>
              <input type="text" placeholder="Add Goal" ref={(input) => (this.input = input)} />
              <button onClick={this.addItem}>Add Goal</button>
              <List items={this.props.goals} remove={this.removeItem} />
            </div>
          );
        }
      }

      // APP component

      class App extends React.Component {
        componentDidMount() {
          const { store } = this.props;

          // Console.log all todos and goals living inside de fake database
          Promise.all([API.fetchTodos(), API.fetchGoals()]).then(([todos, goals]) => {
            store.dispatch(receiveDataAction(todos, goals));
          });

          store.subscribe(() => this.forceUpdate());
        }

        render() {
          const { store } = this.props;
          const { todos, goals, loading } = store.getState();

          if (loading === true) {
            return <h3>Loading...</h3>;
          }

          return (
            <div>
              <Todos todos={todos} store={store} />
              <Goals goals={goals} store={store} />
            </div>
          );
        }
      }

      // RENDER call

      ReactDOM.render(<App store={store} />, document.getElementById('app'));
    </script>
  </body>
</html>
